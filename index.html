<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> <title>NoteMate++</title>
<style>
/* CSS C≈® GI·ªÆ NGUY√äN */
body { margin:0; font-family: Arial; display:flex; height:100vh; background:#f0f2f5; overflow: hidden; }
.sidebar { width:220px; background:#004aad; color:white; padding:20px 10px; }
.sidebar div { padding:15px; margin-bottom:10px; border-radius:8px; cursor:pointer; background:#005be0; text-align:center; font-size:18px; }
.sidebar div:hover { background:#0077ff; }
.main { flex:1; padding:20px; }
.record-box { background:#fff; padding:20px; width:60%; border-radius:12px; box-shadow:0 0 10px #00000033; }
.audio-list { margin-top:15px; padding:10px; background:#d0e4ff; border-radius:8px; max-height:180px; overflow-y:auto; }
.record-btn { background:red; color:white; padding:8px 20px; border:none; border-radius:12px; cursor:pointer; }

/* CSS POPUP CHUNG */
.popup { width:350px; height:450px; position:fixed; background:white; border-radius:12px; box-shadow:0 0 12px #00000055; display:none; flex-direction:column; z-index: 1000; }
.popup header { background:#007bff; color:white; padding:10px; border-radius:12px 12px 0 0; cursor:move; text-align:center; user-select: none; touch-action: none; /* Quan tr·ªçng ƒë·ªÉ k√©o tr√™n mobile */ }

/* V·ªä TR√ç M·∫∂C ƒê·ªäNH */
/* Chatbot n·∫±m b√™n ph·∫£i */
#chatPopup { right: 20px; bottom: 20px; }

/* Chat C·ªông ƒë·ªìng n·∫±m b√™n TR√ÅI */
#groupChatPopup { left: 20px; bottom: 20px; }

/* Ghi ch√∫ n·∫±m gi·ªØa (ƒë√£ ch·ªânh trong JS/CSS c≈©) */
#notePopup { top: 50%; left: 50%; transform: translate(-50%, -50%); display:flex; }
#notePopup textarea { flex:1; margin:10px; resize:none; padding:10px; border-radius:8px; }

.messages { flex:1; padding:10px; overflow-y:auto; font-size:15px; }
.input-area { display:flex; padding:10px; }
.input-area input { flex:1; padding:8px; border:1px solid #aaa; border-radius:8px; }
.input-area button { margin-left:5px; background:#007bff; border:none; color:white; padding:8px 12px; border-radius:8px; cursor:pointer; }
</style>
</head>
<body>

<div id="namePopup" style="position: fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:12px; box-shadow:0 0 20px #0003; width:300px; text-align:center; z-index:2000;">
<h3>Nh·∫≠p t√™n c·ªßa b·∫°n</h3>
<input id="nameInput" placeholder="T√™n..." style="width:90%; padding:8px; border-radius:8px; margin-bottom:10px;">
<button onclick="saveName()" style="padding:8px 20px; background:#007bff; color:white; border:none; border-radius:8px; cursor:pointer;">OK</button>
</div>

<div class="sidebar">
<div onclick="openNote()">üìù Ghi ch√∫</div>
<div onclick="toggleChat()">ü§ñ Chatbot AI</div>
<div onclick="openGroupChat()">üåç C·ªông ƒë·ªìng</div>
</div>

<div class="main">
<div class="record-box">
<h2>Ghi √¢m</h2>
<button class="record-btn">B·∫Øt ƒë·∫ßu ghi</button>
<div class="audio-list"></div>
</div>
</div>

<div id="chatPopup" class="popup">
<header>Chatbot AI (K√©o t√¥i)</header>
<div id="messages" class="messages"></div>
<div class="input-area">
<input id="msgInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
<button onclick="sendBotMessage()">G·ª≠i</button>
</div>
</div>

<div id="groupChatPopup" class="popup">
<header>C·ªông ƒë·ªìng (K√©o t√¥i)</header>
<div id="groupMessages" class="messages"></div>
<div class="input-area">
<input id="groupMsgInput" placeholder="Nh·∫≠p tin nh·∫Øn..." />
<button onclick="sendGroupMessage()">G·ª≠i</button>
</div>
</div>

<div id="notePopup" class="popup" style="display:flex;">
<header>Ghi ch√∫</header>
<textarea id="noteText" placeholder="Nh·∫≠p ghi ch√∫..."></textarea>
</div>

<script>
// --- JAVASCRIPT ---

function saveName(){
    const name = document.getElementById("nameInput").value.trim();
    if(!name) return alert("H√£y nh·∫≠p t√™n!");
    localStorage.setItem("username", name);
    document.getElementById("namePopup").style.display = "none";
}
window.onload = () => {
    if(!localStorage.getItem("username")) document.getElementById("namePopup").style.display="block";
    else document.getElementById("namePopup").style.display="none";
};

// --- H√ÄM K√âO TH·∫¢ (ƒê√É N√ÇNG C·∫§P CHO MOBILE) ---
function dragElement(elmnt) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    const header = elmnt.querySelector("header");

    if (header) {
        // S·ª± ki·ªán chu·ªôt (PC)
        header.onmousedown = dragMouseDown;
        // S·ª± ki·ªán c·∫£m ·ª©ng (Mobile)
        header.ontouchstart = dragTouchStart;
    }

    // --- X·ª≠ l√Ω chu·ªôt (PC) ---
    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        // N·∫øu l√† popup Note ƒëang canh gi·ªØa, c·∫ßn reset transform ƒë·ªÉ k√©o m∆∞·ª£t
        if(elmnt.id === "notePopup") elmnt.style.transform = "none";
        
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }

    // --- X·ª≠ l√Ω c·∫£m ·ª©ng (Mobile) ---
    function dragTouchStart(e) {
        const touch = e.touches[0];
        pos3 = touch.clientX;
        pos4 = touch.clientY;
        document.ontouchend = closeDragElement;
        document.ontouchmove = elementDragTouch;
    }

    function elementDragTouch(e) {
        // NgƒÉn cu·ªôn m√†n h√¨nh khi ƒëang k√©o popup
        // e.preventDefault(); 
        const touch = e.touches[0];
        pos1 = pos3 - touch.clientX;
        pos2 = pos4 - touch.clientY;
        pos3 = touch.clientX;
        pos4 = touch.clientY;

        if(elmnt.id === "notePopup") elmnt.style.transform = "none";

        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
        document.ontouchend = null;
        document.ontouchmove = null;
    }
}

// K√≠ch ho·∫°t k√©o th·∫£
dragElement(document.getElementById("chatPopup"));
dragElement(document.getElementById("groupChatPopup"));
dragElement(document.getElementById("notePopup"));

// Popups Toggle
function openNote(){ document.getElementById("notePopup").style.display="flex"; }
function toggleChat(){ 
    const p = document.getElementById("chatPopup");
    p.style.display=(p.style.display==="flex")?"none":"flex"; 
}
function openGroupChat(){ document.getElementById("groupChatPopup").style.display="flex"; }

// Ghi √¢m
let mediaRecorder,chunks=[];
const recordBtn = document.querySelector(".record-btn");
const audioList = document.querySelector(".audio-list");
recordBtn.onclick = async ()=>{
    if(recordBtn.textContent==="B·∫Øt ƒë·∫ßu ghi"){
        try {
            const stream = await navigator.mediaDevices.getUserMedia({audio:true});
            mediaRecorder = new MediaRecorder(stream);
            chunks=[];
            mediaRecorder.ondataavailable=e=>chunks.push(e.data);
            mediaRecorder.onstop=()=>{
                const audio=document.createElement("audio");
                audio.controls=true;
                audio.src=URL.createObjectURL(new Blob(chunks));
                audioList.appendChild(audio);
            };
            mediaRecorder.start();
            recordBtn.textContent="D·ª´ng ghi";
        } catch(e) { alert("Ch∆∞a c·∫•p quy·ªÅn mic!"); }
    }else{
        mediaRecorder.stop();
        recordBtn.textContent="B·∫Øt ƒë·∫ßu ghi";
    }
};

// API URL (ƒê·ªÉ tr·ªëng cho Render)
const API_URL = ""; 

// Chat nh√≥m
async function sendGroupMessage(){
    const input = document.getElementById("groupMsgInput");
    const text = input.value.trim();
    if(!text) return;
    const name = localStorage.getItem("username");
    
    await fetch(`${API_URL}/groupMessages`,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({name,text})
    });
    input.value="";
    loadGroupMessages();
}
async function loadGroupMessages(){
    try {
        const res = await fetch(`${API_URL}/groupMessages`);
        const data = await res.json();
        const box = document.getElementById("groupMessages");
        box.innerHTML="";
        data.forEach(m=>{
            const div=document.createElement("div");
            div.innerHTML=`<strong>${m.sender}:</strong> ${m.text}`;
            box.appendChild(div);
        });
    } catch(e) {}
}
setInterval(loadGroupMessages,2000);

// Chatbot AI
async function sendBotMessage(){
    const input = document.getElementById("msgInput");
    const box = document.getElementById("messages");
    const text = input.value.trim();
    if(!text) return;

    const userDiv = document.createElement("div");
    userDiv.innerHTML = `<strong>B·∫°n:</strong> ${text}`;
    userDiv.style.color = "blue";
    box.appendChild(userDiv);
    box.scrollTop = box.scrollHeight;

    input.value=""; 

    try {
        const res = await fetch(`${API_URL}/bot`,{
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body:JSON.stringify({text})
        });
        
        const data = await res.json();
        const div = document.createElement("div");
        div.innerHTML = `<strong>${data.sender}:</strong> ${data.text}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    } catch(err) {
        const div = document.createElement("div");
        div.style.color = "red";
        div.innerHTML = "L·ªói k·∫øt n·ªëi Server!";
        box.appendChild(div);
    }
}
</script>

</body>
</html>
